# 7. ìŠ¤í”„ë§ ë³´ì•ˆ(Spring Security)

## ì¸ì¦(Authentication) vs ì¸ê°€(Authorization)

**ì¸ì¦(Authentication)**ê³¼ **ì¸ê°€(Authorization)**ëŠ”
 ì›¹ ë³´ì•ˆ ë° ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ê³„ì—ì„œ **ê°€ì¥ ê¸°ë³¸ì ì´ê³  ì¤‘ìš”í•œ ê°œë…**ì…ë‹ˆë‹¤.
 ë‘ ìš©ì–´ëŠ” í˜¼ë™ë˜ê¸° ì‰½ì§€ë§Œ, **ì™„ì „íˆ ë‹¤ë¥¸ ëª©ì **ì„ ê°€ì§€ê³  ìˆìœ¼ë©°,
 Spring Securityì™€ ê°™ì€ ë³´ì•ˆ í”„ë ˆì„ì›Œí¬ì—ì„œ **ë³„ë„ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.**

------

### âœ… 1. ì •ì˜ ë¹„êµ

| ê°œë…                      | ì •ì˜                                                         |
| ------------------------- | ------------------------------------------------------------ |
| **ì¸ì¦ (Authentication)** | **"ë„ˆëŠ” ëˆ„êµ¬ëƒ?"** ì‚¬ìš©ìì˜ ì‹ ì›ì„ í™•ì¸í•˜ëŠ” ì ˆì°¨ (ë¡œê·¸ì¸ ë“±) |
| **ì¸ê°€ (Authorization)**  | **"ë„ˆëŠ” ì´ê±¸ í•  ìˆ˜ ìˆëƒ?"** ì¸ì¦ëœ ì‚¬ìš©ìê°€ **ë¬´ì—‡ì„ í•  ìˆ˜ ìˆëŠ”ì§€** ê²°ì •í•˜ëŠ” ì ˆì°¨ (ê¶Œí•œ ê²€ì‚¬ ë“±) |

------

### âœ… 2. ë¹„ìœ ì  ì„¤ëª…

- **ì¸ì¦**: ë‹¹ì‹ ì´ **ëˆ„êµ¬ì¸ì§€ í™•ì¸** (ì˜ˆ: ID/PWë¡œ ë¬¸ ì—´ê¸°)
- **ì¸ê°€**: ë‹¹ì‹ ì´ **ë¬´ìŠ¨ ê¶Œí•œì´ ìˆëŠ”ì§€ ê²°ì •** (ì˜ˆ: VIP ë¼ìš´ì§€ ì…ì¥ ê°€ëŠ¥ ì—¬ë¶€)

------

### âœ… 3. ì¸ì¦(Authentication) ìƒì„¸

| í•­ëª©    | ì„¤ëª…                                         |
| ------- | -------------------------------------------- |
| ëª©ì     | ì‚¬ìš©ì í™•ì¸ (ë¡œê·¸ì¸ ì„±ê³µ ì—¬ë¶€)               |
| ê¸°ì¤€    | ìê²© ì¦ëª… (ID, ë¹„ë°€ë²ˆí˜¸, í† í° ë“±)            |
| ê²°ê³¼    | SecurityContextì— `Authentication` ê°ì²´ ì €ì¥ |
| ì‹¤íŒ¨ ì‹œ | `401 Unauthorized`                           |

**Spring Security ì˜ˆ:**

```
UsernamePasswordAuthenticationToken auth = 
    new UsernamePasswordAuthenticationToken(username, password);
authenticationManager.authenticate(auth);
```

------

### âœ… 4. ì¸ê°€(Authorization) ìƒì„¸

| í•­ëª©    | ì„¤ëª…                                  |
| ------- | ------------------------------------- |
| ëª©ì     | ì ‘ê·¼ ê¶Œí•œ ë¶€ì—¬/ì°¨ë‹¨                   |
| ê¸°ì¤€    | ì‚¬ìš©ìì— ë¶€ì—¬ëœ ê¶Œí•œ(Role, Authority) |
| ë°©ì‹    | URL, ë©”ì„œë“œ, ë„ë©”ì¸ ë³„ ê¶Œí•œ ê²€ì‚¬      |
| ì‹¤íŒ¨ ì‹œ | `403 Forbidden`                       |

**Spring Security ì˜ˆ:**

```
@PreAuthorize("hasRole('ADMIN')")
public void deleteUser(Long id) { ... }
```

------

### âœ… 5. Spring Securityì—ì„œì˜ êµ¬ë¶„

| ë‹¨ê³„                 | ì²˜ë¦¬ ë‚´ìš©                                                  |
| -------------------- | ---------------------------------------------------------- |
| ì¸ì¦(Authentication) | ë¡œê·¸ì¸ â†’ Authentication ê°ì²´ ìƒì„± â†’ SecurityContextì— ì €ì¥ |
| ì¸ê°€(Authorization)  | ìš”ì²­ ì‹œ `AccessDecisionManager`ê°€ ê¶Œí•œ ì²´í¬ ìˆ˜í–‰           |

------

### âœ… 6. HTTP ìƒíƒœ ì½”ë“œ ì°¨ì´

| ìƒíƒœ ì½”ë“œ          | ìƒí™©                                                         |
| ------------------ | ------------------------------------------------------------ |
| `401 Unauthorized` | ì¸ì¦ì´ ë˜ì§€ ì•Šì€ ì‚¬ìš©ì (ë¡œê·¸ì¸ ì‹¤íŒ¨, í† í° ì—†ìŒ ë“±)          |
| `403 Forbidden`    | ì¸ì¦ì€ ë˜ì—ˆì§€ë§Œ ê¶Œí•œì´ ì—†ëŠ” ì‚¬ìš©ì (ì˜ˆ: ROLE_USERë¡œ ê´€ë¦¬ì API ìš”ì²­) |

------

### âœ… 7. JWT ê¸°ë°˜ ì¸ì¦/ì¸ê°€ íë¦„ ì˜ˆ

```
[í´ë¼ì´ì–¸íŠ¸] â†’ ë¡œê·¸ì¸ ìš”ì²­
           â†’ JWT í† í° ë°œê¸‰ ë°›ìŒ

[í´ë¼ì´ì–¸íŠ¸] â†’ API ìš”ì²­ ì‹œ Authorization: Bearer <token> í—¤ë” í¬í•¨

[ì„œë²„]
    1. í† í°ì„ ë””ì½”ë“œí•˜ì—¬ ì‚¬ìš©ì í™•ì¸ â†’ ì¸ì¦(Authentication)
    2. ì‚¬ìš©ì ê¶Œí•œ í™•ì¸ â†’ ì¸ê°€(Authorization)
    3. ê¶Œí•œì´ ì—†ìœ¼ë©´ 403 Forbidden
```

------

### âœ… 8. ì˜ˆì‹œ ì½”ë“œ ë¹„êµ

#### ì¸ì¦ ì²˜ë¦¬ ì˜ˆ (Spring Security)

```
@PostMapping("/login")
public ResponseEntity<?> login(@RequestBody LoginDto dto) {
    Authentication authentication = authenticationManager.authenticate(
        new UsernamePasswordAuthenticationToken(dto.getUsername(), dto.getPassword())
    );
    SecurityContextHolder.getContext().setAuthentication(authentication);
    return ResponseEntity.ok(tokenProvider.generateToken(authentication));
}
```

------

#### ì¸ê°€ ì²˜ë¦¬ ì˜ˆ

```
@PreAuthorize("hasRole('ADMIN')")
@GetMapping("/admin/users")
public List<User> getAllUsers() {
    return userService.findAll();
}
```

------

### âœ… 9. ê²°ë¡  ìš”ì•½

| í•­ëª©              | ì¸ì¦(Authentication)    | ì¸ê°€(Authorization)                      |
| ----------------- | ----------------------- | ---------------------------------------- |
| ì§ˆë¬¸              | "ë„ˆ ëˆ„êµ¬ì•¼?"            | "ë„ˆ ì´ê±° í•´ë„ ë¼?"                       |
| ëª©ì               | ì‹ ì› í™•ì¸               | ê¶Œí•œ í™•ì¸                                |
| ì…ë ¥              | ID, ë¹„ë°€ë²ˆí˜¸, í† í° ë“±   | ì¸ì¦ëœ ì‚¬ìš©ìì— ë¶€ì—¬ëœ ê¶Œí•œ              |
| ì‹¤íŒ¨ ì‹œ ìƒíƒœ ì½”ë“œ | 401 Unauthorized        | 403 Forbidden                            |
| Spring ìœ„ì¹˜       | `AuthenticationManager` | `AccessDecisionManager`, `@PreAuthorize` |

------

### **ğŸ‘‰ ì •ë¦¬**

- ë¡œê·¸ì¸ì€ "ì¸ì¦"
- ê¶Œí•œ í™•ì¸ì€ "ì¸ê°€"
- ë‘˜ì€ **ìˆœì°¨ì **, **êµ¬ë¶„ë˜ë©°**, **í˜‘ë ¥í•¨**

## Spring Security ê¸°ë³¸ êµ¬ì¡°

**Spring Security**ëŠ” Spring ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ **ì¸ì¦(Authentication)**ê³¼ **ì¸ê°€(Authorization)**ë¥¼ ì œê³µí•˜ëŠ” **ë³´ì•ˆ í”„ë ˆì„ì›Œí¬**ì…ë‹ˆë‹¤.
 ì›¹ ë³´ì•ˆ, ë©”ì„œë“œ ë³´ì•ˆ, JWT ì¸ì¦, ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ ë“± ëª¨ë“  ë³´ì•ˆ ìš”êµ¬ ì‚¬í•­ì„ í†µí•©ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ëŠ” Spring Securityì˜ **ê¸°ë³¸ êµ¬ì¡°, í•µì‹¬ íë¦„, í•„í„° ì²´ì¸, ì£¼ìš” ì»´í¬ë„ŒíŠ¸**ì— ëŒ€í•œ ì •ë¦¬ì…ë‹ˆë‹¤.

------

### âœ… 1. Spring Security ì „ì²´ êµ¬ì¡° íë¦„

```
[HTTP ìš”ì²­]
   â†“
Spring Security Filter Chain (ë³´ì•ˆ í•„í„°ë“¤)
   â†“
ì¸ì¦ ì²˜ë¦¬(Authentication)
   â†“
ì¸ê°€ ì²˜ë¦¬(Authorization)
   â†“
Controller, Service ë“± ì‹¤ì œ ë¡œì§ ì‹¤í–‰
```

------

### âœ… 2. í•µì‹¬ ì»´í¬ë„ŒíŠ¸

| ì»´í¬ë„ŒíŠ¸                 | ì—­í•                               |
| ------------------------ | --------------------------------- |
| `SecurityFilterChain`    | ëª¨ë“  ë³´ì•ˆ ê´€ë ¨ í•„í„°ë¥¼ í¬í•¨í•œ ì²´ì¸ |
| `AuthenticationManager`  | ë¡œê·¸ì¸ ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ì‹¬ ê°ì²´  |
| `AuthenticationProvider` | ì‹¤ì œ ì¸ì¦ì„ ìˆ˜í–‰ (DB ì¡°íšŒ ë“±)     |
| `UserDetailsService`     | ì‚¬ìš©ì ì •ë³´ë¥¼ ë¡œë”©í•˜ëŠ” ì„œë¹„ìŠ¤     |
| `PasswordEncoder`        | ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ë° ê²€ì¦           |
| `SecurityContextHolder`  | ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ ì €ì¥ì†Œ         |
| `AccessDecisionManager`  | ì¸ê°€ ê²°ì • ì²˜ë¦¬                    |

------

### âœ… 3. ì¸ì¦(Authentication) íë¦„ ìš”ì•½

```
1. ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ìš”ì²­ (POST /login)
2. UsernamePasswordAuthenticationFilterê°€ ìš”ì²­ ê°€ë¡œì±”
3. AuthenticationManager â†’ AuthenticationProvider í˜¸ì¶œ
4. UserDetailsServiceë¡œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
5. ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ í›„ Authentication ê°ì²´ ìƒì„±
6. SecurityContextHolderì— Authentication ì €ì¥
```

------

### âœ… 4. ì¸ê°€(Authorization) íë¦„ ìš”ì•½

```
1. ì¸ì¦ëœ ì‚¬ìš©ìì˜ Authenticationì—ì„œ ê¶Œí•œ(Role)ì„ êº¼ëƒ„
2. ìš”ì²­í•œ URL ë˜ëŠ” ë©”ì„œë“œê°€ í—ˆìš©ëœ ê¶Œí•œì¸ì§€ íŒë‹¨
3. í—ˆìš©: ì»¨íŠ¸ë¡¤ëŸ¬ ì§„ì… / ê±°ë¶€: 403 Forbidden ë°˜í™˜
```

------

### âœ… 5. Spring Security Filter Chain

Spring SecurityëŠ” ë‹¤ìŒê³¼ ê°™ì€ **ìˆ˜ì‹­ ê°œì˜ í•„í„°ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰**í•©ë‹ˆë‹¤:

| í•„í„°                                   | ì„¤ëª…                         |
| -------------------------------------- | ---------------------------- |
| `SecurityContextPersistenceFilter`     | ì¸ì¦ ì •ë³´ì˜ ì„¸ì…˜ ì €ì¥/ë³µì›   |
| `UsernamePasswordAuthenticationFilter` | ë¡œê·¸ì¸ ì²˜ë¦¬ (ê¸°ë³¸ í¼ ë¡œê·¸ì¸) |
| `BasicAuthenticationFilter`            | HTTP Basic ì¸ì¦ ì²˜ë¦¬         |
| `BearerTokenAuthenticationFilter`      | JWT í† í° ì¸ì¦                |
| `ExceptionTranslationFilter`           | ì˜ˆì™¸ ì²˜ë¦¬ ë° 403/401 ë°˜í™˜    |
| `FilterSecurityInterceptor`            | ì¸ê°€ ì²˜ë¦¬ ìˆ˜í–‰ (ê¶Œí•œ ê²€ì‚¬)   |

â†’ ê°€ì¥ ì¤‘ìš”í•œ í•„í„°ëŠ” `UsernamePasswordAuthenticationFilter` (ì¸ì¦)
 â†’ ê°€ì¥ ë§ˆì§€ë§‰ì€ `FilterSecurityInterceptor` (ì¸ê°€)

------

### âœ… 6. ê¸°ë³¸ ì„¤ì • ì˜ˆì‹œ (Spring Boot 3.x ì´ìƒ)

```
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(AbstractHttpConfigurer::disable)
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/admin/**").hasRole("ADMIN")
                .requestMatchers("/user/**").authenticated()
                .anyRequest().permitAll()
            )
            .formLogin(Customizer.withDefaults())
            .logout(Customizer.withDefaults());
        return http.build();
    }
}
```

------

### âœ… 7. ì‚¬ìš©ì ì¸ì¦ ì„¤ì •

```
@Bean
public UserDetailsService userDetailsService() {
    return username -> userRepository.findByUsername(username)
        .map(CustomUserDetails::new)
        .orElseThrow(() -> new UsernameNotFoundException("ì‚¬ìš©ì ì—†ìŒ"));
}
```

```
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}
```

------

### âœ… 8. ë¡œê·¸ì¸ ì„±ê³µ í›„ Authentication ì •ë³´ ì €ì¥

```
Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
String username = authentication.getName();
List<GrantedAuthority> authorities = (List<GrantedAuthority>) authentication.getAuthorities();
```

------

### âœ… 9. ì¸ê°€ ì–´ë…¸í…Œì´ì…˜

| ì–´ë…¸í…Œì´ì…˜                          | ì„¤ëª…                          |
| ----------------------------------- | ----------------------------- |
| `@Secured("ROLE_ADMIN")`            | ë‹¨ìˆœ ê¶Œí•œ ì²´í¬                |
| `@PreAuthorize("hasRole('ADMIN')")` | ë©”ì„œë“œ ì‹¤í–‰ ì „ ê²€ì‚¬           |
| `@PostAuthorize`                    | ë©”ì„œë“œ ì‹¤í–‰ í›„ ê²°ê³¼ ê¸°ë°˜ ê²€ì‚¬ |
| `@RolesAllowed`                     | JSR-250 í˜¸í™˜ ì–´ë…¸í…Œì´ì…˜       |

------

### âœ… 10. ì •ë¦¬ êµ¬ì¡°ë„

```
[í´ë¼ì´ì–¸íŠ¸ ìš”ì²­]
       â†“
[SecurityFilterChain]
       â†“
[UsernamePasswordAuthenticationFilter] â† ì¸ì¦ ìˆ˜í–‰
       â†“
[AuthenticationManager] + [UserDetailsService]
       â†“
[SecurityContextHolder] â† ì¸ì¦ ì •ë³´ ì €ì¥
       â†“
[FilterSecurityInterceptor] â† ì¸ê°€(ê¶Œí•œ í™•ì¸)
       â†“
[ì»¨íŠ¸ë¡¤ëŸ¬ ì§„ì…]
```

------

### âœ… ê²°ë¡ 

- **Spring SecurityëŠ” í•„í„° ê¸°ë°˜ ë³´ì•ˆ ì²´ê³„**
- ì¸ì¦ì€ `AuthenticationManager`ì™€ `UserDetailsService` ì¤‘ì‹¬
- ì¸ê°€ëŠ” `AccessDecisionManager`, `FilterSecurityInterceptor`ê°€ ë‹´ë‹¹
- Spring Bootì—ì„œëŠ” ë³´ì•ˆ ì„¤ì •ì„ `SecurityFilterChain`ì„ í†µí•´ ì„ ì–¸ì ìœ¼ë¡œ êµ¬ì„±
- `SecurityContextHolder`ì— ì¸ì¦ ì •ë³´ê°€ ì €ì¥ë˜ë©°, ì¸ê°€ ì²˜ë¦¬ ì‹œ ì°¸ì¡°ë¨

## ì‚¬ìš©ì ì •ì˜ ì¸ì¦ í•„í„°

**ì‚¬ìš©ì ì •ì˜ ì¸ì¦ í•„í„°(Custom Authentication Filter)**ëŠ”
 Spring Securityì—ì„œ ê¸°ë³¸ ì œê³µí•˜ëŠ” `UsernamePasswordAuthenticationFilter`ë¥¼ ëŒ€ì²´í•˜ê±°ë‚˜ í™•ì¥í•˜ì—¬,
 **íŠ¹ì • ì¸ì¦ ë°©ì‹(JWT, API Key, ì†Œì…œ ë¡œê·¸ì¸, OTP ë“±)**ì— ë§ì¶˜ ì¸ì¦ ë¡œì§ì„ êµ¬í˜„í•  ë•Œ ì‚¬ìš©ëœë‹¤.

ì´ì œ **ì‚¬ìš©ì ì •ì˜ ì¸ì¦ í•„í„°ì˜ ê°œë…, êµ¬ì„± ìš”ì†Œ, êµ¬í˜„ ì ˆì°¨, ì „ì²´ íë¦„**ì„ ì •ë¦¬í•˜ê² ë‹¤.

------

### âœ… 1. ì™œ ì‚¬ìš©ì ì •ì˜ ì¸ì¦ í•„í„°ê°€ í•„ìš”í•œê°€?

ê¸°ë³¸ì ìœ¼ë¡œ Spring SecurityëŠ” `formLogin()` ê¸°ë°˜ì˜ **ID/PW ë¡œê·¸ì¸**ë§Œì„ ì§€ì›í•œë‹¤.
 í•˜ì§€ë§Œ ì‹¤ë¬´ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ **ë§ì¶¤ ì¸ì¦ ë°©ì‹**ì´ í•„ìš”í•˜ë‹¤:

- JWT ì¸ì¦ í—¤ë” ì²˜ë¦¬
- API Key ì¸ì¦
- OAuth í† í° ì¸ì¦
- QR/OTP ê¸°ë°˜ ì¸ì¦
- ëª¨ë°”ì¼ ë¡œê·¸ì¸/ì‚¬ì„¤ ì¸ì¦ ì‹œìŠ¤í…œ

â†’ ì´ë•Œ **ì‚¬ìš©ì ì •ì˜ ì¸ì¦ í•„í„°**ë¥¼ ë§Œë“¤ì–´ `SecurityFilterChain`ì— ë“±ë¡í•˜ì—¬ ì²˜ë¦¬í•œë‹¤.

------

### âœ… 2. ì „ì²´ êµ¬ì¡° ìš”ì•½

```
[ìš”ì²­ (Authorization: Bearer xxx)]
   â†“
[CustomAuthenticationFilter]  â† ì¸ì¦ ì‹œë„
   â†“
[AuthenticationManager]       â† ì¸ì¦ ìœ„ì„
   â†“
[CustomAuthenticationProvider] â† ì¸ì¦ ìˆ˜í–‰
   â†“
[Authentication ê°ì²´ ìƒì„±]
   â†“
[SecurityContextHolderì— ì €ì¥]
```

------

### âœ… 3. ì‚¬ìš©ì ì •ì˜ í•„í„° êµ¬í˜„ ì ˆì°¨

#### âœ” 1) Authentication ê°ì²´ ì •ì˜ (ì„ íƒì )

```
public class JwtAuthenticationToken extends AbstractAuthenticationToken {
    private final String token;

    public JwtAuthenticationToken(String token) {
        super(null);
        this.token = token;
        setAuthenticated(false); // ì¸ì¦ ì „
    }

    @Override
    public Object getPrincipal() {
        return token;
    }

    @Override
    public Object getCredentials() {
        return token;
    }
}
```

------

#### âœ” 2) CustomAuthenticationFilter êµ¬í˜„

```
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private final AuthenticationManager authenticationManager;

    public JwtAuthenticationFilter(AuthenticationManager authenticationManager) {
        this.authenticationManager = authenticationManager;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain chain)
            throws ServletException, IOException {

        String token = request.getHeader("Authorization");

        if (token != null && token.startsWith("Bearer ")) {
            token = token.substring(7);

            Authentication authRequest = new JwtAuthenticationToken(token);
            Authentication authResult = authenticationManager.authenticate(authRequest);

            SecurityContextHolder.getContext().setAuthentication(authResult);
        }

        chain.doFilter(request, response);
    }
}
```

------

#### âœ” 3) CustomAuthenticationProvider êµ¬í˜„

```
@Component
public class JwtAuthenticationProvider implements AuthenticationProvider {

    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        String token = (String) authentication.getCredentials();

        // í† í° ìœ íš¨ì„± ê²€ì¦
        if (validateToken(token)) {
            String username = extractUsername(token);
            List<GrantedAuthority> authorities = List.of(new SimpleGrantedAuthority("ROLE_USER"));

            return new UsernamePasswordAuthenticationToken(username, token, authorities);
        }

        throw new BadCredentialsException("Invalid JWT Token");
    }

    @Override
    public boolean supports(Class<?> authentication) {
        return JwtAuthenticationToken.class.isAssignableFrom(authentication);
    }
}
```

------

#### âœ” 4) SecurityConfigì— í•„í„° ë“±ë¡

```
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    private final JwtAuthenticationProvider jwtAuthenticationProvider;

    public SecurityConfig(JwtAuthenticationProvider provider) {
        this.jwtAuthenticationProvider = provider;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        AuthenticationManager authManager = authenticationManager(http);

        return http
            .csrf(AbstractHttpConfigurer::disable)
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()
                .anyRequest().authenticated()
            )
            .addFilterBefore(new JwtAuthenticationFilter(authManager), UsernamePasswordAuthenticationFilter.class)
            .build();
    }

    @Bean
    public AuthenticationManager authenticationManager(HttpSecurity http) throws Exception {
        return http
            .getSharedObject(AuthenticationManagerBuilder.class)
            .authenticationProvider(jwtAuthenticationProvider)
            .build();
    }
}
```

------

### âœ… 4. ì¸ì¦ í›„ ì²˜ë¦¬

Spring SecurityëŠ” í•„í„° í†µê³¼ í›„ `SecurityContextHolder`ì— `Authentication`ì„ ì €ì¥í•œë‹¤.
 â†’ ì´í›„ `@AuthenticationPrincipal`, `SecurityContextHolder.getContext()` ë“±ì„ í†µí•´ ì‚¬ìš©ì ì •ë³´ ì ‘ê·¼ ê°€ëŠ¥

------

### âœ… 5. ì‹¤íŒ¨ ì²˜ë¦¬ (ì„ íƒì )

```
@Override
protected void doFilterInternal(...) {
    try {
        // ì¸ì¦ ë¡œì§
    } catch (AuthenticationException ex) {
        response.setStatus(HttpStatus.UNAUTHORIZED.value());
        response.getWriter().write("Authentication Failed: " + ex.getMessage());
        return;
    }

    chain.doFilter(request, response);
}
```

------

### âœ… 6. ì „ì²´ íë¦„ ìš”ì•½

```
[JWT ì¸ì¦ ìš”ì²­]
   â†“
[CustomAuthenticationFilter]  â†’ í† í° ì¶”ì¶œ
   â†“
[JwtAuthenticationToken ìƒì„±]  â†’ ì¸ì¦ ì „
   â†“
[AuthenticationManager] ìœ„ì„
   â†“
[JwtAuthenticationProvider] â†’ í† í° ê²€ì¦ + ì‚¬ìš©ì ì •ë³´ ë¡œë”©
   â†“
[UsernamePasswordAuthenticationToken ë°˜í™˜] â†’ ì¸ì¦ ì™„ë£Œ
   â†“
[SecurityContextHolderì— ì €ì¥]
   â†“
[ì»¨íŠ¸ë¡¤ëŸ¬ ì§„ì… â†’ ì¸ì¦ ì •ë³´ ì‚¬ìš© ê°€ëŠ¥]
```

------

### âœ… 7. ê²°ë¡ 

| í•­ëª©      | ì„¤ëª…                                                         |
| --------- | ------------------------------------------------------------ |
| ëª©ì       | ê¸°ë³¸ ë¡œê·¸ì¸ ë°©ì‹ ì™¸ì˜ **ë§ì¶¤ ì¸ì¦ ì²˜ë¦¬** êµ¬í˜„                |
| í•„ìˆ˜ êµ¬ì„± | `CustomFilter`, `AuthenticationToken`, `AuthenticationProvider` |
| ë“±ë¡ ìœ„ì¹˜ | `SecurityFilterChain.addFilterBefore(...)`                   |
| ì‹¤ë¬´ ì˜ˆ   | JWT, OAuth2, API Key ì¸ì¦, ì‚¬ì„¤ ë¡œê·¸ì¸                       |

## JWT ê¸°ë°˜ ì¸ì¦ ì²˜ë¦¬

**JWT ê¸°ë°˜ ì¸ì¦ ì²˜ë¦¬**ëŠ” Spring Securityì—ì„œ ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” **í† í° ê¸°ë°˜ ì¸ì¦ ë°©ì‹**ì…ë‹ˆë‹¤.
 ì„¸ì…˜ ì—†ì´ë„ í´ë¼ì´ì–¸íŠ¸ê°€ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ìˆê³ ,
 REST API í™˜ê²½ì—ì„œ **ë¬´ìƒíƒœ(Stateless)**ë¡œ ì¸ì¦ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆëŠ” ê°•ë ¥í•œ ë°©ë²•ì…ë‹ˆë‹¤.

ì•„ë˜ëŠ” **JWT ê¸°ë°˜ ì¸ì¦ì˜ ì „ì²´ êµ¬ì¡°, íë¦„, êµ¬í˜„ ì „ëµ**ì„ ìˆœì„œëŒ€ë¡œ ì •ë¦¬í•œ ë‚´ìš©ì…ë‹ˆë‹¤.

------

### âœ… 1. JWT ì¸ì¦ì´ë€?

> JWT (JSON Web Token)ëŠ” **ì‚¬ìš©ì ì •ë³´ë¥¼ ì„œëª…ëœ í† í°**ìœ¼ë¡œ ì¸ì½”ë”©í•˜ì—¬
>  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬í•˜ê³ , ì´í›„ ìš”ì²­ë§ˆë‹¤ ì¸ì¦ì„ í† í° ê¸°ë°˜ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì´ë‹¤.

------

### âœ… 2. ì „ì²´ ì¸ì¦ íë¦„ ìš”ì•½

```
[1] ë¡œê·¸ì¸ ìš”ì²­ (ID/PW)
   â†“
[2] ì„œë²„ì—ì„œ JWT ë°œê¸‰ (accessToken)
   â†“
[3] í´ë¼ì´ì–¸íŠ¸ê°€ ì´í›„ ìš”ì²­ ì‹œ í—¤ë”ì— í† í° í¬í•¨
   â†“
[4] í•„í„°ì—ì„œ í† í° ê²€ì¦
   â†“
[5] ì¸ì¦ ì„±ê³µ ì‹œ SecurityContextì— ì €ì¥
   â†“
[6] ì¸ê°€ ì²˜ë¦¬ â†’ ì»¨íŠ¸ë¡¤ëŸ¬ ì‹¤í–‰
```

------

### âœ… 3. JWT êµ¬ì¡°

```
eyJhbGciOiJIUzI1NiJ9.         // Header
eyJzdWIiOiJ1c2VySWQiLCJyb2xlIjpbIlVTRVIiXX0.     // Payload (claim)
7dbsafsd97dsaf...             // Signature
```

| êµ¬ì„±      | ì„¤ëª…                 |
| --------- | -------------------- |
| Header    | alg, typ             |
| Payload   | ì‚¬ìš©ì ì •ë³´ (Claims) |
| Signature | ë¹„ë°€ í‚¤ë¡œ ì„œëª…       |

------

### âœ… 4. JWT ë°œê¸‰ (ë¡œê·¸ì¸ ì‹œ)

#### ìš”ì²­

```
POST /login
Content-Type: application/json

{
  "username": "kim",
  "password": "1234"
}
```

#### ì‘ë‹µ

```
{
  "accessToken": "eyJhbGci...xxx",
  "refreshToken": "eyJhbGci...yyy"
}
```

------

### âœ… 5. JWT ë°œê¸‰ ì½”ë“œ (TokenProvider)

```
@Component
public class JwtTokenProvider {

    private final String secretKey = "very-secret-key";
    private final long expiration = 1000 * 60 * 60; // 1ì‹œê°„

    public String generateToken(String username, List<String> roles) {
        return Jwts.builder()
            .setSubject(username)
            .claim("roles", roles)
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + expiration))
            .signWith(SignatureAlgorithm.HS256, secretKey.getBytes())
            .compact();
    }

    public Claims parseToken(String token) {
        return Jwts.parser()
            .setSigningKey(secretKey.getBytes())
            .parseClaimsJws(token)
            .getBody();
    }

    public boolean validate(String token) {
        try {
            parseToken(token);
            return true;
        } catch (JwtException e) {
            return false;
        }
    }
}
```

------

### âœ… 6. ì¸ì¦ í•„í„° (`JwtAuthenticationFilter`)

```
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private final JwtTokenProvider tokenProvider;

    public JwtAuthenticationFilter(JwtTokenProvider provider) {
        this.tokenProvider = provider;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)
        throws ServletException, IOException {

        String token = resolveToken(request);
        if (token != null && tokenProvider.validate(token)) {
            Claims claims = tokenProvider.parseToken(token);
            String username = claims.getSubject();
            List<GrantedAuthority> authorities = ((List<?>) claims.get("roles")).stream()
                .map(role -> new SimpleGrantedAuthority("ROLE_" + role))
                .toList();

            Authentication auth = new UsernamePasswordAuthenticationToken(username, token, authorities);
            SecurityContextHolder.getContext().setAuthentication(auth);
        }

        chain.doFilter(request, response);
    }

    private String resolveToken(HttpServletRequest request) {
        String header = request.getHeader("Authorization");
        return (header != null && header.startsWith("Bearer ")) ? header.substring(7) : null;
    }
}
```

------

### âœ… 7. Security ì„¤ì •ì— í•„í„° ë“±ë¡

```
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    private final JwtTokenProvider tokenProvider;

    public SecurityConfig(JwtTokenProvider tokenProvider) {
        this.tokenProvider = tokenProvider;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(AbstractHttpConfigurer::disable)
            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/login", "/signup").permitAll()
                .anyRequest().authenticated()
            )
            .addFilterBefore(new JwtAuthenticationFilter(tokenProvider), UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}
```

------

### âœ… 8. ì¸ì¦ í›„ ì‚¬ìš©ì ì •ë³´ ì ‘ê·¼

```
@GetMapping("/me")
public String getUserInfo(Authentication authentication) {
    return authentication.getName(); // username
}
```

ë˜ëŠ”

```
@GetMapping("/me")
public String getUserInfo(@AuthenticationPrincipal UserDetails user) {
    return user.getUsername();
}
```

------

### âœ… 9. ìƒíƒœ ì½”ë“œ ì˜ˆì™¸ ì²˜ë¦¬ (ì„ íƒ ì‚¬í•­)

```
@ExceptionHandler(AccessDeniedException.class)
public ResponseEntity<ErrorResponse> handleForbidden() {
    return ResponseEntity.status(403).body(new ErrorResponse(403, "ì ‘ê·¼ ê±°ë¶€"));
}

@ExceptionHandler(AuthenticationException.class)
public ResponseEntity<ErrorResponse> handleUnauthorized() {
    return ResponseEntity.status(401).body(new ErrorResponse(401, "ì¸ì¦ ì‹¤íŒ¨"));
}
```

------

### âœ… 10. ê²°ë¡  ìš”ì•½

| í•­ëª©      | ì„¤ëª…                                                         |
| --------- | ------------------------------------------------------------ |
| ì¸ì¦ ë°©ì‹ | ë¡œê·¸ì¸ ì‹œ JWT ë°œê¸‰ í›„, ì´í›„ ëª¨ë“  ìš”ì²­ì— í¬í•¨                 |
| Stateless | ì„¸ì…˜ ì—†ì´ ì¸ì¦ ì²˜ë¦¬ (RESTì— ì í•©)                            |
| ì¸ì¦ íë¦„ | JWT â†’ í•„í„° â†’ `Authentication` ì €ì¥                           |
| ì¸ê°€ ì²˜ë¦¬ | JWT ë‚´ Role ê¸°ë°˜ â†’ `hasRole`, `@PreAuthorize` í™œìš©           |
| ì¥ì       | ì„œë²„ í™•ì¥ì„±, ë¬´ì„¸ì…˜, ëª¨ë°”ì¼/SPA ì¹œí™”ì                        |
| ë‹¨ì       | í† í° íƒˆì·¨ ì‹œ ëŒ€ì‘ ì–´ë ¤ì›€ â†’ ë§Œë£Œ ì‹œê°„ ì„¤ì •, RefreshToken ë„ì… í•„ìš” |

## OAuth2 ë¡œê·¸ì¸ ì²˜ë¦¬

**OAuth2 ë¡œê·¸ì¸ ì²˜ë¦¬**ëŠ” Spring Securityì—ì„œ ì†Œì…œ ë¡œê·¸ì¸(Google, Kakao, Naver, GitHub ë“±)ì„ êµ¬í˜„í•˜ê¸° ìœ„í•œ **í‘œì¤€ ì¸ì¦ í”„ë¡œí† ì½œ**ì…ë‹ˆë‹¤.
 Spring Bootì—ì„œëŠ” ì´ë¥¼ ê°„í¸í•˜ê²Œ êµ¬ì„±í•  ìˆ˜ ìˆë„ë¡ `spring-boot-starter-oauth2-client` ëª¨ë“ˆì„ ì œê³µí•©ë‹ˆë‹¤.

------

### âœ… 1. OAuth2 ë¡œê·¸ì¸ íë¦„ ê°œìš”

```
[1] ì‚¬ìš©ìê°€ "ì†Œì…œ ë¡œê·¸ì¸" ë²„íŠ¼ í´ë¦­
   â†“
[2] ì¸ì¦ ì„œë²„(Google ë“±)ë¡œ ë¦¬ë””ë ‰ì…˜
   â†“
[3] ì‚¬ìš©ì ë¡œê·¸ì¸ â†’ ê¶Œí•œ ë¶€ì—¬
   â†“
[4] ì½œë°± URLë¡œ Access Token ë°˜í™˜
   â†“
[5] ë¦¬ì†ŒìŠ¤ ì„œë²„ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
   â†“
[6] Spring Securityê°€ ì‚¬ìš©ì ì¸ì¦ ì™„ë£Œ
```

------

### âœ… 2. ì˜ì¡´ì„± ì¶”ê°€ (Gradle)

```
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
}
```

------

### âœ… 3. application.yml ì„¤ì • ì˜ˆ (Google)

```
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: YOUR_CLIENT_ID
            client-secret: YOUR_CLIENT_SECRET
            scope: profile, email
        provider:
          google:
            authorization-uri: https://accounts.google.com/o/oauth2/v2/auth
            token-uri: https://oauth2.googleapis.com/token
            user-info-uri: https://www.googleapis.com/oauth2/v3/userinfo
```

------

### âœ… 4. ê¸°ë³¸ ë¡œê·¸ì¸ URL

```
GET /oauth2/authorization/google
```

â†’ ì´ URLì— ì ‘ì†í•˜ë©´ Spring Securityê°€ ìë™ìœ¼ë¡œ Google ë¡œê·¸ì¸ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜

------

### âœ… 5. OAuth2 ê¸°ë³¸ êµ¬ì¡°

| ì»´í¬ë„ŒíŠ¸                          | ì—­í•                               |
| --------------------------------- | --------------------------------- |
| `OAuth2LoginAuthenticationFilter` | ì¸ì¦ ì‹œì‘ í•„í„°                    |
| `OAuth2UserService`               | ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ                  |
| `OAuth2User`                      | OAuth ì œê³µìì—ì„œ ë°›ì€ ì‚¬ìš©ì ì •ë³´ |
| `PrincipalOauth2UserService`      | ì‚¬ìš©ì ì»¤ìŠ¤í…€ ë§¤í•‘                |

------

### âœ… 6. ì‚¬ìš©ì ì •ë³´ ì»¤ìŠ¤í„°ë§ˆì´ì§•

#### 1) ì»¤ìŠ¤í…€ OAuth2UserService

```
@Service
public class CustomOAuth2UserService extends DefaultOAuth2UserService {

    @Override
    public OAuth2User loadUser(OAuth2UserRequest request) throws OAuth2AuthenticationException {
        OAuth2User oAuth2User = super.loadUser(request);

        String registrationId = request.getClientRegistration().getRegistrationId(); // "google", "naver"
        String userNameAttrName = request.getClientRegistration()
            .getProviderDetails().getUserInfoEndpoint().getUserNameAttributeName();

        Map<String, Object> attributes = oAuth2User.getAttributes();

        // ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
        String email = (String) attributes.get("email");
        String name = (String) attributes.get("name");

        return new DefaultOAuth2User(
            Collections.singleton(new SimpleGrantedAuthority("ROLE_USER")),
            attributes,
            userNameAttrName
        );
    }
}
```

------

#### 2) SecurityConfigì— ë“±ë¡

```
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    private final CustomOAuth2UserService customOAuth2UserService;

    public SecurityConfig(CustomOAuth2UserService service) {
        this.customOAuth2UserService = service;
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(AbstractHttpConfigurer::disable)
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/login/**").permitAll()
                .anyRequest().authenticated()
            )
            .oauth2Login(oauth -> oauth
                .loginPage("/login")
                .userInfoEndpoint(userInfo -> userInfo
                    .userService(customOAuth2UserService)
                )
            );
        return http.build();
    }
}
```

------

### âœ… 7. ë¡œê·¸ì¸ í›„ ì‚¬ìš©ì ì •ë³´ ì ‘ê·¼

```
@GetMapping("/profile")
public String profile(@AuthenticationPrincipal OAuth2User user) {
    return "Hello, " + user.getAttribute("name");
}
```

------

### âœ… 8. ì‹¤ë¬´ í™•ì¥ ì „ëµ

| í•­ëª©               | ì„¤ëª…                                        |
| ------------------ | ------------------------------------------- |
| ì»¤ìŠ¤í…€ UserDetails | OAuth2User â†’ ë¡œì»¬ UserDetails ë³€í™˜          |
| íšŒì›ê°€ì… ì—°ë™      | ì²˜ìŒ ë¡œê·¸ì¸ ì‹œ DB ì €ì¥ ë° ì—­í•  ë¶€ì—¬         |
| JWT ì—°ë™           | OAuth2 ë¡œê·¸ì¸ ì„±ê³µ ì‹œ JWT ë°œê¸‰ í›„ ì „ë‹¬      |
| ìƒíƒœê°’ ì €ì¥        | `OAuth2AuthorizationRequestRepository` ì‚¬ìš© |
| ì†Œì…œ ì—°ë™          | Google, Kakao, Naver, GitHub ë™ì‹œ ë“±ë¡ ê°€ëŠ¥ |

------

### âœ… 9. ì˜ˆì‹œ ì‘ë‹µ (Google)

```
{
  "sub": "123456789",
  "name": "Kim",
  "email": "kim@example.com",
  "picture": "https://profile.jpg"
}
```

â†’ `OAuth2User.getAttributes()`ë¥¼ í†µí•´ ì „ì²´ ì ‘ê·¼ ê°€ëŠ¥

------

### âœ… 10. ê²°ë¡ 

| í•­ëª©        | ì„¤ëª…                                                      |
| ----------- | --------------------------------------------------------- |
| ì¸ì¦ ë°©ì‹   | OAuth2 í‘œì¤€ ê¸°ë°˜ (Authorization Code Grant)               |
| URL         | `/oauth2/authorization/{provider}`                        |
| ì‚¬ìš©ì ì •ë³´ | `OAuth2UserService`ë¡œ ì»¤ìŠ¤í„°ë§ˆì´ì§•                        |
| í™•ì¥ì„±      | JWT ë°œê¸‰, DB ì—°ë™, ì¶”ê°€ ê¶Œí•œ ë¶€ì—¬ ê°€ëŠ¥                    |
| ê¶Œì¥ ì „ëµ   | â‘  OAuth2 ë¡œê·¸ì¸ â†’ â‘¡ ì‚¬ìš©ì ì •ë³´ ì €ì¥ â†’ â‘¢ JWT ë°œê¸‰ í›„ ì‘ë‹µ |

## CSRF, CORS, ì„¸ì…˜ ë³´ì•ˆ

ì›¹ ë³´ì•ˆì—ì„œ ë°˜ë“œì‹œ ì´í•´í•˜ê³  ëŒ€ì‘í•´ì•¼ í•  3ê°€ì§€ í•µì‹¬ ì£¼ì œê°€ ë°”ë¡œ ë‹¤ìŒì…ë‹ˆë‹¤:

- **CSRF (Cross-Site Request Forgery)**
- **CORS (Cross-Origin Resource Sharing)**
- **ì„¸ì…˜ ë³´ì•ˆ(Session Security)**

ì´ë“¤ì€ ì„œë¡œ ë‹¤ë¥¸ ë³´ì•ˆ ì˜ì—­ì´ì§€ë§Œ, Spring Securityì—ì„œëŠ” **ëª…í™•í•œ ì œì–´ ë„êµ¬ì™€ ì„¤ì • ë°©ë²•**ì´ ì¡´ì¬í•©ë‹ˆë‹¤.
 ì•„ë˜ì— ì´ ì„¸ ê°€ì§€ë¥¼ êµ¬ì¡°ì ìœ¼ë¡œ ì„¤ëª…í•˜ê³ , ì‹¤ë¬´ ëŒ€ì‘ ë°©ë²•ê¹Œì§€ ì •ë¦¬í•©ë‹ˆë‹¤.

------

### âœ… 1. CSRF (Cross-Site Request Forgery)

#### ğŸ“Œ ê°œë…

> **ì‚¬ìš©ìê°€ ì˜ë„í•˜ì§€ ì•Šì€ ìš”ì²­ì„ ì•…ì˜ì ì¸ ì‚¬ì´íŠ¸ê°€ ìë™ìœ¼ë¡œ ìˆ˜í–‰**í•˜ê²Œ ë§Œë“œëŠ” ê³µê²©

- ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•œ ìƒíƒœì—ì„œ, ê³µê²©ìê°€ **ì •ìƒ ì‚¬ì´íŠ¸ì˜ ê¶Œí•œì„ ë„ìš©**í•˜ì—¬ ìš”ì²­ì„ ì „ì†¡
- ì˜ˆ: ì‚¬ìš©ì ì¸ì¦ ì¿ í‚¤ê°€ ìë™ ì „ì†¡ë˜ëŠ” íŠ¹ì„±ì„ ì´ìš©

#### ğŸ“Œ ì˜ˆì‹œ ê³µê²©

```
<img src="https://bank.com/transfer?amount=10000&to=attacker" />
```

â†’ ë¸Œë¼ìš°ì €ê°€ `bank.com`ì— ë¡œê·¸ì¸ëœ ìƒíƒœë¼ë©´ ìë™ìœ¼ë¡œ ì „ì†¡ë¨

------

#### âœ… Spring Securityì—ì„œ ê¸°ë³¸ ë°©ì–´

Spring SecurityëŠ” **`csrf()` ë³´í˜¸ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”**í•œë‹¤.
 â†’ `POST`, `PUT`, `DELETE` ìš”ì²­ì€ **CSRF í† í°ì´ ì—†ìœ¼ë©´ 403 Forbidden**

#### âœ… ì„¤ì • ì˜ˆì‹œ

```
http
    .csrf(csrf -> csrf
        .ignoringRequestMatchers("/api/**") // REST APIëŠ” ë¬´ìƒíƒœ â†’ CSRF ë¹„í™œì„±í™”
    );
```

#### âœ… ë¹„í™œì„±í™” (ë¬´ìƒíƒœ API)

```
http.csrf(AbstractHttpConfigurer::disable); // JWT ê¸°ë°˜ REST APIì—ì„œ ì‚¬ìš©
```

------

### âœ… 2. CORS (Cross-Origin Resource Sharing)

#### ğŸ“Œ ê°œë…

> **ë¸Œë¼ìš°ì €ê°€ ë‹¤ë¥¸ Origin(ì¶œì²˜)ì˜ ë¦¬ì†ŒìŠ¤ ìš”ì²­ì„ ì°¨ë‹¨**í•˜ëŠ” ê¸°ë³¸ ë³´ì•ˆ ì •ì±… (Same-Origin Policy)

- ì˜ˆ: `frontend.com`ì—ì„œ `api.backend.com`ì— ìš”ì²­ â†’ ì°¨ë‹¨ë¨
- ë¸Œë¼ìš°ì €ëŠ” `OPTIONS` í”„ë¦¬í”Œë¼ì´íŠ¸ ìš”ì²­ìœ¼ë¡œ í—ˆìš© ì—¬ë¶€ë¥¼ ë¨¼ì € ê²€ì¦

------

#### âœ… Spring ì„¤ì • ë°©ë²•

```
@Bean
public WebMvcConfigurer corsConfigurer() {
    return new WebMvcConfigurer() {
        @Override
        public void addCorsMappings(CorsRegistry registry) {
            registry.addMapping("/**")
                .allowedOrigins("http://localhost:3000")
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowCredentials(true);
        }
    };
}
```

> `allowCredentials(true)` ì„¤ì • ì‹œ, **`allowedOrigins("\*")` ì‚¬ìš© ë¶ˆê°€**

------

#### âœ… SecurityConfigì—ì„œ CORS í—ˆìš©

```
http.cors(Customizer.withDefaults());
```

â†’ `WebMvcConfigurer`ì™€ í•¨ê»˜ ì‘ë™í•˜ë„ë¡ í•¨

------

### âœ… 3. ì„¸ì…˜ ë³´ì•ˆ

#### ğŸ“Œ ê°œë…

> ì„œë²„ê°€ ë¸Œë¼ìš°ì €ì˜ ìƒíƒœë¥¼ ê¸°ì–µí•˜ê¸° ìœ„í•´ ìœ ì§€í•˜ëŠ” ì €ì¥ ê³µê°„ â†’ ê³µê²© ëŒ€ìƒì´ ë  ìˆ˜ ìˆìŒ

------

#### âœ… ì„¸ì…˜ ê³ ì • ê³µê²© ë°©ì§€ (Session Fixation)

Spring SecurityëŠ” ë¡œê·¸ì¸ ì‹œ ìë™ìœ¼ë¡œ **ì„¸ì…˜ IDë¥¼ ë³€ê²½**í•˜ì—¬ ê³µê²© ë°©ì§€

```
http.sessionManagement(session -> 
    session.sessionFixation(SessionFixationConfigurer::migrateSession)
);
```

- `migrateSession` (ê¸°ë³¸): ê¸°ì¡´ ì„¸ì…˜ ì†ì„± ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œìš´ ID ë¶€ì—¬

------

#### âœ… ì„¸ì…˜ í•˜ì´ì¬í‚¹ ëŒ€ì‘

| ì „ëµ                | ì„¤ëª…                                                   |
| ------------------- | ------------------------------------------------------ |
| HTTPS ì‚¬ìš©          | ì¿ í‚¤ íƒˆì·¨ ë°©ì§€                                         |
| `HttpOnly` ì¿ í‚¤     | JavaScript ì ‘ê·¼ ì°¨ë‹¨                                   |
| ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ       | ìœ íœ´ ì„¸ì…˜ ìë™ ë§Œë£Œ (`server.servlet.session.timeout`) |
| ìµœëŒ€ ë™ì‹œ ì„¸ì…˜ ì œí•œ | í•œ ì‚¬ìš©ìë‹¹ 1íšŒ ë¡œê·¸ì¸ ì œí•œ                            |

```
http.sessionManagement(session -> session
    .maximumSessions(1)
    .maxSessionsPreventsLogin(true)
);
```

------

#### âœ… Stateless ë°©ì‹ (JWT ì¸ì¦)

JWT ê¸°ë°˜ ë¡œê·¸ì¸ì—ì„œëŠ” ì„¸ì…˜ì„ ì™„ì „íˆ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

```
http.sessionManagement(session ->
    session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
);
```

------

### âœ… ì •ë¦¬ ë¹„êµí‘œ

| í•­ëª©      | ëª©ì                               | ìœ„í˜‘                        | Spring ì²˜ë¦¬ ë°©ì‹                |
| --------- | --------------------------------- | --------------------------- | ------------------------------- |
| CSRF      | ì•…ì˜ì  ì‚¬ì´íŠ¸ì˜ ìš”ì²­ ìœ„ì¡° ë°©ì§€    | ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì¿ í‚¤ ì•…ìš©   | `csrf().enable()` (ê¸°ë³¸ í™œì„±í™”) |
| CORS      | ë¸Œë¼ìš°ì € ì¶œì²˜ ê°„ ë¦¬ì†ŒìŠ¤ ê³µìœ  ì œí•œ | ë‹¤ë¥¸ Origin ìš”ì²­ ì°¨ë‹¨       | `http.cors()` + `CorsRegistry`  |
| ì„¸ì…˜ ë³´ì•ˆ | ì¸ì¦ëœ ì„¸ì…˜ íƒˆì·¨, ê³ ì • ë°©ì§€       | Session Fixation, Hijacking | `sessionManagement()` ì„¤ì •      |

------

### âœ… ê²°ë¡ 

| ë³´ì•ˆ ìš”ì†Œ | REST API í™˜ê²½ì—ì„œëŠ”?                          |
| --------- | --------------------------------------------- |
| CSRF      | âŒ ë¹„í™œì„±í™” ê¶Œì¥ (`csrf().disable()`)          |
| CORS      | âœ… ë°˜ë“œì‹œ ëª…ì‹œì  í—ˆìš© í•„ìš” (`http.cors()`)     |
| ì„¸ì…˜      | âœ… `SessionCreationPolicy.STATELESS` ì„¤ì • í•„ìˆ˜ |

## ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” (BCrypt)

Spring Securityì—ì„œ **ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”ì˜ í‘œì¤€ ë°©ì‹**ì€ `BCryptPasswordEncoder`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.
 BCryptëŠ” í•´ì‹œ ê¸°ë°˜ì˜ ë‹¨ë°©í–¥ ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ,
 **ì—­ì‚°ì´ ë¶ˆê°€ëŠ¥í•˜ê³ , ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²©(Brute Force)ì— ë§¤ìš° ê°•í•œ êµ¬ì¡°**ë¥¼ ê°€ì§€ê³  ìˆë‹¤.

------

### âœ… 1. ì™œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•”í˜¸í™”í•´ì•¼ í•˜ëŠ”ê°€?

| ì´ìœ                 | ì„¤ëª…                                                   |
| ------------------- | ------------------------------------------------------ |
| ë³´ì•ˆì„±              | í‰ë¬¸ ë¹„ë°€ë²ˆí˜¸ ì €ì¥ì€ ì¹˜ëª…ì ì¸ ë³´ì•ˆ ìœ„í˜‘                |
| í•´í‚¹ ì‹œ í”¼í•´ ìµœì†Œí™” | DB ìœ ì¶œë˜ë”ë¼ë„ ë³µí˜¸í™”ê°€ ë¶ˆê°€ëŠ¥í•´ì•¼ í•¨                 |
| ë‹¨ë°©í–¥ì„±            | ì‚¬ìš©ìì˜ ì…ë ¥ê³¼ ì €ì¥ëœ í•´ì‹œê°’ì„ ë¹„êµ (ë³µí˜¸í™” ì•„ë‹˜)     |
| ë‚œìˆ˜ì„±              | ë™ì¼í•œ ì…ë ¥ê°’ â†’ ë§¤ë²ˆ ë‹¤ë¥¸ í•´ì‹œê°’ ìƒì„± (Salt ìë™ í¬í•¨) |

------

### âœ… 2. BCrypt íŠ¹ì§• ìš”ì•½

| í•­ëª©            | ë‚´ìš©                                            |
| --------------- | ----------------------------------------------- |
| ì•Œê³ ë¦¬ì¦˜        | ë‹¨ë°©í–¥ í•´ì‹œ í•¨ìˆ˜                                |
| Salt            | ë‚´ë¶€ì ìœ¼ë¡œ ìë™ ìƒì„± ë° í¬í•¨                    |
| ë°˜ë³µ íšŸìˆ˜(cost) | ê¸°ë³¸ 10íšŒ, ë†’ì¼ìˆ˜ë¡ ë³´ì•ˆ ì¦ê°€                   |
| ë³µí˜¸í™”          | ë¶ˆê°€ëŠ¥ (ë‹¨, ì…ë ¥ê°’ì„ ë‹¤ì‹œ ì•”í˜¸í™”í•´ ë¹„êµëŠ” ê°€ëŠ¥) |
| ì•ˆì „ì„±          | Rainbow Table, Brute Forceì— ê°•í•¨               |

------

### âœ… 3. Springì—ì„œ `BCryptPasswordEncoder` ì‚¬ìš© ë°©ë²•

#### 1) ì˜ì¡´ì„± í¬í•¨ (Spring Boot Security ì‚¬ìš© ì‹œ ê¸°ë³¸ í¬í•¨)

```
implementation 'org.springframework.boot:spring-boot-starter-security'
```

------

#### 2) PasswordEncoder Bean ë“±ë¡

```
@Configuration
public class SecurityConfig {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(); // ê¸°ë³¸ cost=10
    }
}
```

------

#### 3) ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ì˜ˆ

```
@Autowired
private PasswordEncoder passwordEncoder;

public void registerUser(String rawPassword) {
    String encodedPassword = passwordEncoder.encode(rawPassword);
    userRepository.save(new User(..., encodedPassword));
}
```

â†’ `encode()`ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ salt í¬í•¨ + í•´ì‹œ ì‹¤í–‰

------

#### 4) ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë¹„êµ

```
public void login(String rawPassword, String encodedPasswordFromDB) {
    if (!passwordEncoder.matches(rawPassword, encodedPasswordFromDB)) {
        throw new IllegalArgumentException("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.");
    }
}
```

â†’ `matches()`ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ saltë¥¼ ì¶”ì¶œí•´ ì¬í•´ì‹œí•˜ì—¬ ë¹„êµ

------

### âœ… 4. BCrypt í•´ì‹œ ì˜ˆì‹œ

```
$2a$10$uOZk8sVdrxoKqfnSEVUEu.HKn8Rv7TCvMSxtdMQmLt93ZKk/AF12e
```

| êµ¬ì„±       | ì„¤ëª…                    |
| ---------- | ----------------------- |
| `$2a$`     | ì•Œê³ ë¦¬ì¦˜ ë²„ì „           |
| `10`       | cost factor (2^10 ë°˜ë³µ) |
| `uOZk8...` | salt + hashed password  |

------

### âœ… 5. PasswordEncoder í™•ì¥ ì „ëµ

Spring Securityì˜ `DelegatingPasswordEncoder`ë¥¼ ì‚¬ìš©í•˜ë©´ **ë‹¤ì–‘í•œ ì¸ì½”ë”© ì•Œê³ ë¦¬ì¦˜ì„ í˜¼í•© ì§€ì›**í•  ìˆ˜ ìˆë‹¤:

```
@Bean
public PasswordEncoder passwordEncoder() {
    return PasswordEncoderFactories.createDelegatingPasswordEncoder();
}
```

â†’ ê¸°ë³¸ì€ BCrypt, ê¸°ì¡´ SHA-1, PBKDF2 ë“±ë„ ì‚¬ìš© ê°€ëŠ¥
 â†’ `{bcrypt}hashed_string` í˜•íƒœë¡œ ì ‘ë‘ì–´ ì €ì¥

------

### âœ… 6. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹œ ì „ëµ

- ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ëŠ” ë°˜ë“œì‹œ ë‹¤ì‹œ `encode()` í›„ ì €ì¥
- ê°™ì€ ê°’ì´ë¼ë„ í•´ì‹œê°’ì´ ë§¤ë²ˆ ë‹¤ë¥´ë¯€ë¡œ ì¬ì €ì¥ í•„ìš”
- ê¸°ì¡´ `matches()`ëŠ” ì •ìƒ ì‘ë™í•¨

------

### âœ… 7. ê²°ë¡  ìš”ì•½

| í•­ëª©      | ì„¤ëª…                           |
| --------- | ------------------------------ |
| ì•Œê³ ë¦¬ì¦˜  | `BCryptPasswordEncoder` ì‚¬ìš©   |
| encode()  | ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ + salt í¬í•¨ ì €ì¥ |
| matches() | ì…ë ¥ê°’ â†’ í•´ì‹œ ë¹„êµ             |
| ë³µí˜¸í™”    | âŒ ë¶ˆê°€ëŠ¥ (ë‹¨ë°©í–¥)              |
| ì €ì¥ ìœ„ì¹˜ | DBì— í•´ì‹œê°’ë§Œ ì €ì¥             |